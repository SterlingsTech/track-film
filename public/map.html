<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Live Package Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script>
      const PROJECT = "goofy-rattle-casquette"; // your Glitch project name
      const MAPBOX_TOKEN =
        "pk.eyJ1IjoiYXNpZGF0LXRlc3QiLCJhIjoiY21hM3ExbnNpMmt1NjJrc21hemppdHlmZyJ9.P8Olfvt6pYjiyzHHOkAG4g";

      const params = new URLSearchParams(window.location.search);
      const recId = params.get("recId");
      if (!recId) {
        alert("Please provide ?recId=<your-record-id> in the URL");
        throw new Error("recId missing");
      }

      const DATA_URL = `https://${PROJECT}.glitch.me/data/${recId}`;

      const map = L.map("map").setView([51.505, -0.09], 13);
      L.tileLayer(
        `https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
        { id: "mapbox/streets-v11", tileSize: 512, zoomOffset: -1 }
      ).addTo(map);

      function render() {
        fetch(DATA_URL)
          .then((r) => r.json())
          .then((data) => {
            map.eachLayer((layer) => {
              if (layer.options && layer.options.pane === "overlayPane") {
                map.removeLayer(layer);
              }
            });

            let addressPoint = null;

            // Find address location for zone drawing
            const addressFeature = data.features.find(
              (f) => f.properties.event === "address"
            );
            if (addressFeature) {
              const [addrLng, addrLat] = addressFeature.geometry.coordinates;
              addressPoint = [addrLat, addrLng];

              const p = turf.point([addrLng, addrLat]);

              // Zone 3: nearest street (~100 m)
              L.geoJSON(turf.buffer(p, 100, { units: "meters" }), {
                style: {
                  color: "orange",
                  fillColor: "orange",
                  fillOpacity: 0.2,
                  weight: 2,
                },
              }).addTo(map);

              // Zone 2: neighbours (~30 m)
              L.geoJSON(turf.buffer(p, 30, { units: "meters" }), {
                style: {
                  color: "blue",
                  fillColor: "lightblue",
                  fillOpacity: 0.5,
                  weight: 2,
                },
              }).addTo(map);

              // Zone 1: property lot (~15 m)
              L.geoJSON(turf.buffer(p, 15, { units: "meters" }), {
                style: {
                  color: "green",
                  fillColor: "lightgreen",
                  fillOpacity: 0.2,
                  weight: 2,
                },
              }).addTo(map);

              const bounds = L.geoJSON(data).getBounds();
              map.fitBounds(bounds, { padding: [20, 20] });
            }

            // Add markers with popups
            L.geoJSON(data, {
              pointToLayer: function (feature, latlng) {
                const isOpened = feature.properties.event === "opened";
                const isAddress = feature.properties.event === "address";

                const marker = L.circleMarker(latlng, {
                  radius: 8,
                  color: isOpened ? "grey" : isAddress ? "blue" : "green",
                  fillColor: isOpened
                    ? "lightgrey"
                    : isAddress
                    ? "skyblue"
                    : "lightgreen",
                  fillOpacity: 1,
                  weight: 2,
                });

                marker.bindPopup(`
                  <strong>${feature.properties.event.toUpperCase()}</strong><br>
                  Status: ${feature.properties.status || "N/A"}<br>
                  Left: ${feature.properties.left || "N/A"}
                `);

                return marker;
              },
            }).addTo(map);
          });
      }

      render();
      setInterval(render, 10000);
    </script>
  </body>
</html>
